<link rel='import' href='../bower_components/polymer/polymer.html'>
<link rel='import' href='../bower_components/iron-ajax/iron-ajax.html'>
<link rel='import' href='../bower_components/juicy-ace-editor/juicy-ace-editor.html'>

<script src='../dist/browser_package.js'></script>

<dom-module id='polyup-compare'>
  <style>
    :host {
      max-width: 100%;
    }
    #left {
      display: inline-block;
      width: 50%;
    }
    #right {
      display: inline-block;
      width: 50%;
      float: right;
    }
    #right > * {
      box-sizing: border-box;
      margin-left: 20px;
    }
    #editor {
      width: 100%;
      min-height: 500px;
    }
    #output {
      width: 100%;
      min-height: 500px;
    }
    #wrapper {
      /*margin: 20px;*/
      width: 100%;
    }
    #output .ace_cursor {
      display: none;
    }
    label {
      -webkit-font-smoothing: antialiased;
    }
    .errorMessage {
      color: #C15454
    }
  </style>
  <template>
    <div id='wrapper'>
      <div id='left'>
        <label>Polymer 0.5 input:</label>
        <select id="select" value='{{selectedSample::input}}'>
          <option value="samples/attributes.html" selected>
            Tiny Element
          </option>
          <option value="samples/simple-element.html">
            Larger Element
          </option>
          <option value="samples/flickr-search-app.html">
            Full App
          </option>
        </select>
        <iron-ajax auto url='{{selectedSample}}' handle-as='text'
                   last-response='{{editorInput}}'>
        </iron-ajax>
        <juicy-ace-editor id="editor"
          theme="ace/theme/monokai"
          mode="ace/mode/html"
          setTabSize="2"
          wrapmode
          value="[[editorInput]]"
          ></juicy-ace-editor>
      </div>
      <div id='right'>
        <label>Polymer 1.0 output:</label>
        <span class='errorMessage'>{{errorMessage}}</span>
        <juicy-ace-editor id="output"
          theme="ace/theme/monokai"
          mode="ace/mode/html"
          readonly="true"
          wrapmode
          ></juicy-ace-editor>
      </div>
    </div>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'polyup-compare',
    properties: {
      editorInput: {
        observer: '_editorInputChanged'
      }
    },
    ready: function() {
      var input = this.$.editor;
      this.input = input;
      input.editor.$blockScrolling = Infinity;

      var output = this.$.output;
      this.output = output;
      output.editor.$blockScrolling = Infinity;

      var self = this;
      function onChange() {
        var scrollPos = output.editor.getSession().getScrollTop();
        // Need to delay this because ace assumes that the onchange handler
        // will be very fast, otherwise it drops some keyboard events, and
        // in general behaves *very* strange.
        requestAnimationFrame(function() {
          try {
            var outputVal = Polyup.upgradeHtml(input.value);
          } catch(e) {
            self.errorMessage = e.message || e.toString();
            return;
          }
          self.errorMessage = '';
          output.value = outputVal;
          output.editor.clearSelection()
          output.editor.getSession().setScrollTop(scrollPos);
        })
      }
      input.addEventListener('change', onChange);
      this.selectedSample = this.$.select.value;
    },
    _editorInputChanged: function() {
      this.input.editor.clearSelection();
      this.input.editor.scrollToLine(0);
      this.output.editor.scrollToLine(0);
    }
  })



</script>
