<link rel='import' href='../bower_components/polymer/polymer.html'>
<link rel='import' href='../bower_components/iron-ajax/iron-ajax.html'>

<script src='../dist/browser_package.js'></script>
<script src='../bower_components/ace-builds/src-noconflict/ace.js'></script>

<dom-module id='polyup-compare'>
  <style>
    :host {
      max-width: 100%;
    }
    #left {
      display: inline-block;
      width: 50%;
    }
    #right {
      display: inline-block;
      width: 50%;
      float: right;
    }
    #right > * {
      box-sizing: border-box;
      margin-left: 20px;
    }
    #editor {
      width: 100%;
      min-height: 500px;
    }
    #output {
      width: 100%;
      min-height: 500px;
    }
    #wrapper {
      /*margin: 20px;*/
      width: 100%;
    }
    #output .ace_cursor {
      display: none;
    }
    label {
      -webkit-font-smoothing: antialiased;
    }
    .errorMessage {
      color: #C15454
    }
  </style>
  <template>
    <div id='wrapper'>
      <div id='left'>
        <label>Polymer 0.5 input:</label>
        <select id="select" value='{{selectedSample::input}}'>
          <option value="samples/attributes.html" selected>
            Tiny Element
          </option>
          <option value="samples/simple-element.html">
            Larger Element
          </option>
          <option value="samples/flickr-search-app.html">
            Full App
          </option>
        </select>
        <iron-ajax auto url='{{selectedSample}}' handle-as='text'
                   last-response='{{editorInput}}'>
        </iron-ajax>
        <div id='editor'>
          <!-- This will be an ace editor -->
        </div>
      </div>
      <div id='right'>
        <label>Polymer 1.0 output:</label>
        <span class='errorMessage'>{{errorMessage}}</span>
        <div id='output'>
          <!-- This will be a read-only ace editor -->
        </div>
      </div>
    </div>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'polyup-compare',
    properties: {
      editorInput: {
        observer: '_editorInputChanged'
      }
    },
    ready: function() {
      var editor = ace.edit(this.$.editor);
      this.editor = editor;
      editor.$blockScrolling = Infinity
      editor.setTheme("ace/theme/monokai");
      editor.getSession().setMode("ace/mode/html");
      editor.getSession().setTabSize(2);
      editor.getSession().setUseWrapMode(true);

      var output = ace.edit(this.$.output);
      this.output = output;
      output.$blockScrolling = Infinity
      output.setReadOnly(true);
      output.setTheme("ace/theme/monokai");
      output.getSession().setMode('ace/mode/html');
      output.getSession().setUseWrapMode(true);
      output.setHighlightActiveLine(false);
      output.setHighlightGutterLine(false);

      var self = this;
      function onChange() {
        var scrollPos = output.getSession().getScrollTop();
        var editorValue = editor.getValue();
        // Need to delay this because ace assumes that the onchange handler
        // will be very fast, otherwise it drops some keyboard events, and
        // in general behaves *very* strange.
        requestAnimationFrame(function() {
          try {
            var outputVal = Polyup.upgradeHtml(editor.getValue());
          } catch(e) {
            self.errorMessage = e.message || e.toString();
            return;
          }
          self.errorMessage = '';
          output.setValue(outputVal);
          output.clearSelection()
          output.getSession().setScrollTop(scrollPos);
        })
      }
      editor.getSession().on('change', onChange);
      this.selectedSample = this.$.select.value;
    },
    _editorInputChanged: function() {
      this.editor.setValue(this.editorInput);
      this.editor.clearSelection();
      this.editor.scrollToLine(0);
      this.output.scrollToLine(0);
    }
  })



</script>
